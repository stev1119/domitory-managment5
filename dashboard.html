<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #6b7280;
        }

        /* ê²€ìƒ‰ ì„¹ì…˜ */
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 25px 15px 50px;
            border: 3px solid #e5e7eb;
            border-radius: 50px;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 5px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.2rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-room {
            font-weight: 600;
            color: #4f46e5;
            font-size: 1rem;
        }

        .result-name {
            font-weight: 500;
            color: #1f2937;
            margin: 2px 0;
        }

        .result-status {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* ì „ì²´ í†µê³„ ì¹´ë“œ */
        .total-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 5px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card.total { border-left-color: #10b981; }
        .stat-card.out { border-left-color: #f59e0b; }
        .stat-card.new { border-left-color: #3b82f6; }
        .stat-card.move { border-left-color: #8b5cf6; }
        .stat-card.absent { border-left-color: #6b7280; }
        .stat-card.exit { border-left-color: #ef4444; }

        .stat-card h3 {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        /* ì„±ë³„ í†µê³„ */
        .gender-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .gender-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .gender-section h3 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1f2937;
            font-weight: 600;
        }

        .gender-section.male {
            border-left: 5px solid #3b82f6;
        }

        .gender-section.female {
            border-left: 5px solid #ec4899;
        }

        .gender-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .gender-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gender-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .gender-card .number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .gender-card .label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* ë™ë³„ í†µê³„ */
        .building-stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .building-stats h3 {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #1f2937;
            font-weight: 600;
        }

        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .building-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4f46e5;
        }

        .building-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .building-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .building-type {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .floor-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .floor-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .floor-card:hover {
            border-color: #4f46e5;
            background: #fefefe;
        }

        .floor-card .floor-name {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .floor-card .floor-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }

        /* í•™ìƒ ì •ë³´ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        .students-grid {
            display: grid;
            gap: 15px;
        }

        .student-info-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4f46e5;
            transition: all 0.3s ease;
        }

        .student-info-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .student-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-room {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4f46e5;
        }

        .student-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .status-normal { background: #10b981; }
        .status-out { background: #f59e0b; }
        .status-new { background: #3b82f6; }
        .status-move { background: #8b5cf6; }
        .status-absent { background: #6b7280; }
        .status-exit { background: #ef4444; }

        .student-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 500;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .total-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .gender-stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .buildings-grid {
                grid-template-columns: 1fr;
            }

            .student-details {
                grid-template-columns: 1fr;
            }

            .floor-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ“Š ê¸°ìˆ™ì‚¬ í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
            <p>ì‹¤ì‹œê°„ ì¸ì› í˜„í™© ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="search-section">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="searchInput" placeholder="í•™ìƒ ì´ë¦„, ê¸°ìˆ™ì‚¬ ë²ˆí˜¸, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¢Œì„ë²ˆí˜¸ ë“±ìœ¼ë¡œ ê²€ìƒ‰...">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

        <!-- ì „ì²´ í†µê³„ -->
        <div class="total-stats" id="totalStats">
            <div class="stat-card total" onclick="showStudentsByStatus('total')">
                <h3>ì´ í˜„ì¬ì›</h3>
                <div class="number" id="totalCurrent">0</div>
                <div class="label">ì „ì²´ ì¬í•™ìƒ</div>
            </div>
            <div class="stat-card out" onclick="showStudentsByStatus('ì™¸ë°•')">
                <h3>ì™¸ë°•</h3>
                <div class="number" id="totalOut">0</div>
                <div class="label">ì™¸ë°• ì¤‘ì¸ í•™ìƒ</div>
            </div>
            <div class="stat-card new" onclick="showStudentsByStatus('ì‹ ê·œ')">
                <h3>ì‹ ê·œ</h3>
                <div class="number" id="totalNew">0</div>
                <div class="label">ì‹ ê·œ ì…ì†Œ</div>
            </div>
            <div class="stat-card move" onclick="showStudentsByStatus('ì´ë™')">
                <h3>ì´ë™</h3>
                <div class="number" id="totalMove">0</div>
                <div class="label">ì´ë™ ì˜ˆì •/ì™„ë£Œ</div>
            </div>
            <div class="stat-card absent" onclick="showStudentsByStatus('ë“±ë¯¸')">
                <h3>ë“±ë¯¸</h3>
                <div class="number" id="totalAbsent">0</div>
                <div class="label">ë“±êµ ë¯¸í™•ì¸</div>
            </div>
            <div class="stat-card exit" onclick="showStudentsByStatus('í‡´ì†Œ')">
                <h3>í‡´ì†Œ</h3>
                <div class="number" id="totalExit">0</div>
                <div class="label">í‡´ì†Œ ì²˜ë¦¬</div>
            </div>
        </div>

        <!-- ì„±ë³„ í†µê³„ -->
        <div class="gender-stats">
            <div class="gender-section male">
                <h3>ğŸ‘¨ ë‚¨í•™ìƒ í˜„í™©</h3>
                <div class="gender-cards" id="maleStats">
                    <div class="gender-card" onclick="showStudentsByGender('male', 'total')">
                        <div class="number" id="maleCurrent">0</div>
                        <div class="label">í˜„ì¬ì›</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', 'ì™¸ë°•')">
                        <div class="number" id="maleOut">0</div>
                        <div class="label">ì™¸ë°•</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', 'ì‹ ê·œ')">
                        <div class="number" id="maleNew">0</div>
                        <div class="label">ì‹ ê·œ</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', 'ë“±ë¯¸')">
                        <div class="number" id="maleAbsent">0</div>
                        <div class="label">ë“±ë¯¸</div>
                    </div>
                </div>
            </div>
            <div class="gender-section female">
                <h3>ğŸ‘© ì—¬í•™ìƒ í˜„í™©</h3>
                <div class="gender-cards" id="femaleStats">
                    <div class="gender-card" onclick="showStudentsByGender('female', 'total')">
                        <div class="number" id="femaleCurrent">0</div>
                        <div class="label">í˜„ì¬ì›</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', 'ì™¸ë°•')">
                        <div class="number" id="femaleOut">0</div>
                        <div class="label">ì™¸ë°•</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', 'ì‹ ê·œ')">
                        <div class="number" id="femaleNew">0</div>
                        <div class="label">ì‹ ê·œ</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', 'ë“±ë¯¸')">
                        <div class="number" id="femaleAbsent">0</div>
                        <div class="label">ë“±ë¯¸</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë™ë³„ í†µê³„ -->
        <div class="building-stats">
            <h3>ğŸ¢ ë™ë³„ ì¸µë³„ í˜„í™©</h3>
            <div class="buildings-grid" id="buildingsGrid">
                <!-- ë™ë³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë¡œë”© -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- í•™ìƒ ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">í•™ìƒ ìƒì„¸ ì •ë³´</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="students-grid" id="modalStudentsGrid">
                    <!-- í•™ìƒ ì •ë³´ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let sheetsData = [];
        let reportData = {};
        let searchTimeout;

        // ê¸°ìˆ™ì‚¬ ì •ë³´ ì •ì˜
        const buildingInfo = {
            'A': { name: 'Aë™', type: 'ë‚¨í•™ìƒ', gender: 'male' },
            'B': { name: 'Bë™', type: 'ë‚¨í•™ìƒ', gender: 'male' },
            'C': { name: 'Cë™', type: 'ë‚¨í•™ìƒ', gender: 'male' },
            'D': { name: 'Dë™', type: 'ì—¬í•™ìƒ', gender: 'female' },
            'E': { name: 'Eë™', type: 'ì—¬í•™ìƒ', gender: 'female' },
            'F': { name: 'Fë™', type: 'ë‚¨í•™ìƒ', gender: 'male' }
        };

        // 3ì¸ì‹¤ ì…€ ë²”ìœ„
        const tripleRoomRanges = {
            'A': { start: 188, end: 432 },
            'B': { start: 406, end: 468 },
            'C': { start: 654, end: 749 },
            'D': { start: 884, end: 952 },
            'E': { start: 1185, end: 1304 },
            'F': { start: 1403, end: 1453 }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async function() {
            await loadData();
            setupEventListeners();
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadSheetsData(),
                    loadReportData()
                ]);
                
                updateDashboard();
                showLoading(false);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showLoading(false);
            }
        }

        // êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadSheetsData() {
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values/yulee!A:P?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`);
                const data = await response.json();
                sheetsData = data.values || [];
            } catch (error) {
                console.error('ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë³´ê³  ë°ì´í„° ë¡œë“œ (localStorageì—ì„œ)
        function loadReportData() {
            const savedData = localStorage.getItem('reportData');
            reportData = savedData ? JSON.parse(savedData) : {};
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            const stats = calculateStats();
            updateTotalStats(stats);
            updateGenderStats(stats);
            updateBuildingStats(stats);
        }

        // í†µê³„ ê³„ì‚°
        function calculateStats() {
            const stats = {
                total: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                male: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                female: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                buildings: {}
            };

            // ê° ë™ë³„ë¡œ ì´ˆê¸°í™”
            Object.keys(buildingInfo).forEach(building => {
                stats.buildings[building] = {
                    floors: { '1': 0, '2': 0, '3': 0, '4': 0 },
                    total: 0,
                    gender: buildingInfo[building].gender
                };
            });

            // ì‹œíŠ¸ ë°ì´í„° ë¶„ì„
            sheetsData.forEach((row, index) => {
                if (index === 0) return; // í—¤ë” ì œì™¸
                
                const room = row[1]; // Bì—´ (ê¸°ìˆ™ì‚¬ ë²ˆí˜¸)
                const name = row[2]; // Cì—´ (í•™ìƒ ì´ë¦„)
                const status = row[3] || 'ì •ìƒ'; // Dì—´ (ìƒíƒœ)
                const gender = row[12]; // Mì—´ (ì„±ë³„)

                if (!room || !name || name === 'ë¯¸ë°°ì •') return;

                // ê±´ë¬¼ê³¼ ì¸µ ì¶”ì¶œ
                const building = room.charAt(0);
                const floor = room.charAt(1);

                if (!buildingInfo[building]) return;

                const buildingGender = buildingInfo[building].gender;

                // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
                updateStatsByStatus(stats.total, status);
                
                // ì„±ë³„ í†µê³„ ì—…ë°ì´íŠ¸
                if (buildingGender === 'male') {
                    updateStatsByStatus(stats.male, status);
                } else if (buildingGender === 'female') {
                    updateStatsByStatus(stats.female, status);
                }

                // ë™ë³„ í†µê³„ ì—…ë°ì´íŠ¸
                if (stats.buildings[building]) {
                    if (status === 'ì •ìƒ' || status === 'ì‹ ê·œ' || status === 'ì´ë™+') {
                        stats.buildings[building].floors[floor]++;
                        stats.buildings[building].total++;
                    }
                }
            });

            return stats;
        }

        // ìƒíƒœë³„ í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatsByStatus(statObj, status) {
            switch (status) {
                case 'ì •ìƒ':
                case 'ì‹ ê·œ':
                case 'ì´ë™+':
                    statObj.current++;
                    if (status === 'ì‹ ê·œ') statObj.new++;
                    if (status === 'ì´ë™+') statObj.moveIn++;
                    break;
                case 'ì™¸ë°•':
                    statObj.out++;
                    break;
                case 'ì´ë™-':
                    statObj.moveOut++;
                    break;
                case 'ë“±ë¯¸':
                    statObj.absent++;
                    break;
                case 'í‡´ì†Œ':
                    statObj.exit++;
                    break;
            }
        }

        // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
        function updateTotalStats(stats) {
            document.getElementById('totalCurrent').textContent = stats.total.current;
            document.getElementById('totalOut').textContent = stats.total.out;
            document.getElementById('totalNew').textContent = stats.total.new;
            document.getElementById('totalMove').textContent = stats.total.moveOut + stats.total.moveIn;
            document.getElementById('totalAbsent').textContent = stats.total.absent;
            document.getElementById('totalExit').textContent = stats.total.exit;
        }

        // ì„±ë³„ í†µê³„ ì—…ë°ì´íŠ¸
        function updateGenderStats(stats) {
            // ë‚¨í•™ìƒ
            document.getElementById('maleCurrent').textContent = stats.male.current;
            document.getElementById('maleOut').textContent = stats.male.out;
            document.getElementById('maleNew').textContent = stats.male.new;
            document.getElementById('maleAbsent').textContent = stats.male.absent;

            // ì—¬í•™ìƒ
            document.getElementById('femaleCurrent').textContent = stats.female.current;
            document.getElementById('femaleOut').textContent = stats.female.out;
            document.getElementById('femaleNew').textContent = stats.female.new;
            document.getElementById('femaleAbsent').textContent = stats.female.absent;
        }

        // ë™ë³„ í†µê³„ ì—…ë°ì´íŠ¸
        function updateBuildingStats(stats) {
            const buildingsGrid = document.getElementById('buildingsGrid');
            buildingsGrid.innerHTML = '';

            Object.keys(buildingInfo).forEach(building => {
                const buildingData = stats.buildings[building];
                const info = buildingInfo[building];

                const buildingCard = document.createElement('div');
                buildingCard.className = 'building-card';
                buildingCard.innerHTML = `
                    <div class="building-header">
                        <div class="building-name">${info.name}</div>
                        <div class="building-type">${info.type} (ì´ ${buildingData.total}ëª…)</div>
                    </div>
                    <div class="floor-stats">
                        <div class="floor-card" onclick="showFloorStudents('${building}', '1')">
                            <div class="floor-name">1ì¸µ</div>
                            <div class="floor-count">${buildingData.floors['1']}</div>
                        </div>
                        <div class="floor-card" onclick="showFloorStudents('${building}', '2')">
                            <div class="floor-name">2ì¸µ</div>
                            <div class="floor-count">${buildingData.floors['2']}</div>
                        </div>
                        <div class="floor-card" onclick="showFloorStudents('${building}', '3')">
                            <div class="floor-name">3ì¸µ</div>
                            <div class="floor-count">${buildingData.floors['3']}</div>
                        </div>
                        <div class="floor-card" onclick="showFloorStudents('${building}', '4')">
                            <div class="floor-name">4ì¸µ</div>
                            <div class="floor-count">${buildingData.floors['4']}</div>
                        </div>
                    </div>
                `;
                buildingsGrid.appendChild(buildingCard);
            });
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (query.length < 1) {
                    searchResults.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            // ê²€ìƒ‰ ê²°ê³¼ ì™¸ë¶€ í´ë¦­ ì‹œ ìˆ¨ê¹€
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        // ì‹¤ì‹œê°„ ê²€ìƒ‰ ìˆ˜í–‰
        function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            const results = [];

            const lowerQuery = query.toLowerCase();

            sheetsData.forEach((row, index) => {
                if (index === 0) return; // í—¤ë” ì œì™¸

                const room = row[1] || '';
                const name = row[2] || '';
                const status = row[3] || 'ì •ìƒ';
                const librarySeats = row[8] || '';
                const phone = row[7] || '';
                const parentPhone = row[6] || '';

                // ê²€ìƒ‰ ì¡°ê±´ë“¤
                const searchFields = [
                    room.toLowerCase(),
                    name.toLowerCase(),
                    librarySeats.toLowerCase(),
                    phone,
                    parentPhone
                ].join(' ');

                if (searchFields.includes(lowerQuery) && name && name !== 'ë¯¸ë°°ì •') {
                    results.push({
                        room: room,
                        name: name,
                        status: status,
                        rowData: row
                    });
                }
            });

            displaySearchResults(results);
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                searchResults.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="showStudentDetail('${result.room}')">
                        <div class="result-room">${result.room}</div>
                        <div class="result-name">${result.name}</div>
                        <div class="result-status">ìƒíƒœ: ${result.status}</div>
                    </div>
                `).join('');
            }
            
            searchResults.style.display = 'block';
        }

        // ìƒíƒœë³„ í•™ìƒ ë³´ê¸°
        function showStudentsByStatus(status) {
            const students = getStudentsByStatus(status);
            showStudentsModal(`${status} í•™ìƒ ëª©ë¡`, students);
        }

        // ì„±ë³„ + ìƒíƒœë³„ í•™ìƒ ë³´ê¸°
        function showStudentsByGender(gender, status) {
            const students = getStudentsByGenderAndStatus(gender, status);
            const genderText = gender === 'male' ? 'ë‚¨í•™ìƒ' : 'ì—¬í•™ìƒ';
            showStudentsModal(`${genderText} ${status} ëª©ë¡`, students);
        }

        // ì¸µë³„ í•™ìƒ ë³´ê¸°
        function showFloorStudents(building, floor) {
            const students = getStudentsByFloor(building, floor);
            showStudentsModal(`${building}ë™ ${floor}ì¸µ í•™ìƒ ëª©ë¡`, students);
        }

        // íŠ¹ì • í•™ìƒ ìƒì„¸ ì •ë³´ ë³´ê¸°
        function showStudentDetail(room) {
            const student = sheetsData.find(row => row[1] === room);
            if (student) {
                showStudentsModal(`${room} í•™ìƒ ì •ë³´`, [student]);
            }
            document.getElementById('searchResults').style.display = 'none';
        }

        // ìƒíƒœë³„ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getStudentsByStatus(status) {
            const students = [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const name = row[2];
                const studentStatus = row[3] || 'ì •ìƒ';
                
                if (!name || name === 'ë¯¸ë°°ì •') return;
                
                if (status === 'total') {
                    if (studentStatus === 'ì •ìƒ' || studentStatus === 'ì‹ ê·œ' || studentStatus === 'ì´ë™+') {
                        students.push(row);
                    }
                } else if (status === 'ì´ë™') {
                    if (studentStatus === 'ì´ë™-' || studentStatus === 'ì´ë™+') {
                        students.push(row);
                    }
                } else if (studentStatus === status) {
                    students.push(row);
                }
            });
            
            return students;
        }

        // ì„±ë³„ + ìƒíƒœë³„ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getStudentsByGenderAndStatus(gender, status) {
            const students = getStudentsByStatus(status);
            return students.filter(row => {
                const room = row[1];
                if (!room) return false;
                const building = room.charAt(0);
                return buildingInfo[building] && buildingInfo[building].gender === gender;
            });
        }

        // ì¸µë³„ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getStudentsByFloor(building, floor) {
            const students = [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const room = row[1];
                const name = row[2];
                const status = row[3] || 'ì •ìƒ';
                
                if (!room || !name || name === 'ë¯¸ë°°ì •') return;
                
                if (room.startsWith(building + floor)) {
                    if (status === 'ì •ìƒ' || status === 'ì‹ ê·œ' || status === 'ì´ë™+') {
                        students.push(row);
                    }
                }
            });
            
            return students;
        }

        // í•™ìƒ ëª¨ë‹¬ í‘œì‹œ
        function showStudentsModal(title, students) {
            document.getElementById('modalTitle').textContent = title;
            const modalStudentsGrid = document.getElementById('modalStudentsGrid');
            
            modalStudentsGrid.innerHTML = students.map(row => createStudentCard(row)).join('');
            document.getElementById('studentModal').style.display = 'block';
        }

        // í•™ìƒ ì •ë³´ ì¹´ë“œ ìƒì„±
        function createStudentCard(row) {
            const room = row[1] || '';
            const name = row[2] || '';
            const status = row[3] || 'ì •ìƒ';
            const memo = row[5] || '';
            const parentPhone = row[6] || '';
            const phone = row[7] || '';
            const librarySeats = row[8] || '';
            const lifeTeacher = row[9] || '';
            const birthDate = row[11] || '';
            const gender = row[12] || '';
            const enrollDate = row[13] || '';
            const school = row[14] || '';
            const classroom = row[15] || '';

            const statusClass = getStatusClass(status);

            return `
                <div class="student-info-card">
                    <div class="student-info-header">
                        <div class="student-room">${room}</div>
                        <div class="student-status ${statusClass}">${status}</div>
                    </div>
                    <div class="student-details">
                        <div class="detail-item">
                            <div class="detail-label">ì´ë¦„</div>
                            <div class="detail-value">${name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ì„±ë³„</div>
                            <div class="detail-value">${gender}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ìƒë…„ì›”ì¼</div>
                            <div class="detail-value">${birthDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ë³¸ì¸ì—°ë½ì²˜</div>
                            <div class="detail-value">${phone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">í•™ë¶€ëª¨ì—°ë½ì²˜</div>
                            <div class="detail-value">${parentPhone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¢Œì„</div>
                            <div class="detail-value">${librarySeats}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ìƒí™œë‹´ì„</div>
                            <div class="detail-value">${lifeTeacher}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ì…ì†Œì¼</div>
                            <div class="detail-value">${enrollDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ì¶œì‹ ê³ êµ</div>
                            <div class="detail-value">${school}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ë°˜</div>
                            <div class="detail-value">${classroom}</div>
                        </div>
                        ${memo ? `
                        <div class="detail-item">
                            <div class="detail-label">ë¹„ê³ </div>
                            <div class="detail-value">${memo}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ìƒíƒœ CSS í´ë˜ìŠ¤ ë°˜í™˜
        function getStatusClass(status) {
            switch (status) {
                case 'ì •ìƒ': return 'status-normal';
                case 'ì™¸ë°•': return 'status-out';
                case 'ì‹ ê·œ': return 'status-new';
                case 'ì´ë™-':
                case 'ì´ë™+': return 'status-move';
                case 'ë“±ë¯¸': return 'status-absent';
                case 'í‡´ì†Œ': return 'status-exit';
                default: return 'status-normal';
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('studentModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        function refreshData() {
            loadData();
        }

        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>
