<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시대인재 기숙사 인원 현황</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .header-text {
            text-align: left;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            margin: 0;
        }

        .header p {
            font-size: 1.2rem;
            color: #6b7280;
            margin: 5px 0 0 0;
        }

        /* 검색 섹션 */
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 25px 15px 50px;
            border: 3px solid #e5e7eb;
            border-radius: 50px;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 5px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.2rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-room {
            font-weight: 600;
            color: #4f46e5;
            font-size: 1rem;
        }

        .result-name {
            font-weight: 500;
            color: #1f2937;
            margin: 2px 0;
        }

        .result-status {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* 전체 통계 카드 */
        .total-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 5px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card.total { border-left-color: #10b981; }
        .stat-card.out { border-left-color: #f59e0b; }
        .stat-card.new { border-left-color: #3b82f6; }
        .stat-card.move { border-left-color: #8b5cf6; }
        .stat-card.absent { border-left-color: #6b7280; }
        .stat-card.exit { border-left-color: #ef4444; }

        .stat-card h3 {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        /* 성별 통계 */
        .gender-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .gender-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .gender-section h3 {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1f2937;
            font-weight: 600;
        }

        .gender-section.male {
            border-left: 5px solid #3b82f6;
        }

        .gender-section.female {
            border-left: 5px solid #ec4899;
        }

        .gender-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .gender-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gender-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .gender-card .number {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .gender-card .label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* 동별 통계 */
        .building-stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .building-stats h3 {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #1f2937;
            font-weight: 600;
        }

        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .building-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4f46e5;
        }

        .building-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .building-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .building-type {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .floor-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .floor-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .floor-card:hover {
            border-color: #4f46e5;
            background: #fefefe;
        }

        .floor-card .floor-name {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .floor-card .floor-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }

        /* 구역별 담당자 현황 스타일 */
        .manager-stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .manager-stats h3 {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #1f2937;
            font-weight: 600;
        }

        .area-info-summary {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 12px;
        }

        .area-info-summary p {
            color: #6b7280;
            font-size: 1rem;
            margin: 0;
            font-weight: 500;
        }

        .area-managers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }

        .building-group {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 20px;
            padding: 25px;
            border-left: 5px solid #6366f1;
        }

        .building-group-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .building-group-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .building-group-subtitle {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }

        .floors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .area-manager-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #6366f1;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .area-manager-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left-color: #4f46e5;
        }

        .area-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .area-manager-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .area-manager-zone {
            font-size: 0.9rem;
            color: #6366f1;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .area-stats-compact {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .area-stat-item {
            background: white;
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .area-stat-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .area-stat-item.current { border-color: #10b981; }
        .area-stat-item.out { border-color: #f59e0b; }
        .area-stat-item.new { border-color: #3b82f6; }
        .area-stat-item.absent { border-color: #6b7280; }
        .area-stat-item.move-out { border-color: #ef4444; }
        .area-stat-item.move-in { border-color: #8b5cf6; }
        .area-stat-item.exit { border-color: #dc2626; }

        .area-stat-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .area-stat-label {
            font-size: 0.65rem;
            color: #6b7280;
            font-weight: 500;
        }

        .area-total-summary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .area-building-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(99, 102, 241, 0.2);
            color: #4f46e5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* 학생 정보 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        .students-grid {
            display: grid;
            gap: 15px;
        }

        .student-info-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4f46e5;
            transition: all 0.3s ease;
        }

        .student-info-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .student-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-room {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4f46e5;
        }

        .student-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .status-normal { background: #10b981; }
        .status-out { background: #f59e0b; }
        .status-new { background: #3b82f6; }
        .status-move { background: #8b5cf6; }
        .status-absent { background: #6b7280; }
        .status-exit { background: #ef4444; }

        .student-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 500;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-text {
                text-align: center;
            }

            .header-logo {
                width: 50px;
                height: 50px;
            }

            .total-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .gender-stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .buildings-grid {
                grid-template-columns: 1fr;
            }

            .student-details {
                grid-template-columns: 1fr;
            }

            .floor-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 로딩 애니메이션 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 헤더 -->
        <div class="header">
            <div class="header-content">
                <!-- 구글 드라이브 이미지를 여러 방법으로 시도 -->
                <img src="https://lh3.googleusercontent.com/d/1Zt7J__aLz3uQF02JX3zs0BQtx60OC5bJ" alt="시대인재 로고" class="header-logo" 
                     onerror="this.onerror=null; this.src='https://drive.google.com/uc?export=download&id=1Zt7J__aLz3uQF02JX3zs0BQtx60OC5bJ'; 
                              setTimeout(() => { if(!this.complete || this.naturalWidth === 0) { this.src='https://docs.google.com/uc?export=download&id=1Zt7J__aLz3uQF02JX3zs0BQtx60OC5bJ'; 
                              setTimeout(() => { if(!this.complete || this.naturalWidth === 0) { this.style.display='none'; this.nextElementSibling.style.display='inline'; } }, 1000); } }, 1000);">
                <!-- 로고 로드 실패시 대체 텍스트 -->
                <span style="display: none; font-size: 2.5rem;">🏫</span>
                <div class="header-text">
                    <h1>시대인재 기숙사 인원 현황</h1>
                    <p>실시간 인원 현황 모니터링 시스템</p>
                </div>
            </div>
        </div>

        <!-- 검색 섹션 -->
        <div class="search-section">
            <div class="search-box">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-input" id="searchInput" placeholder="학생 이름, 기숙사 번호, 라브 좌석번호,전번 등으로 검색...">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

        <!-- 전체 통계 -->
        <div class="total-stats" id="totalStats">
            <div class="stat-card total" onclick="showStudentsByStatus('total')">
                <h3>총 현재원</h3>
                <div class="number" id="totalCurrent">0</div>
                <div class="label">전체 재학생</div>
            </div>
            <div class="stat-card out" onclick="showStudentsByStatus('외박')">
                <h3>외박</h3>
                <div class="number" id="totalOut">0</div>
                <div class="label">외박 중인 학생</div>
            </div>
            <div class="stat-card new" onclick="showStudentsByStatus('신규')">
                <h3>신규</h3>
                <div class="number" id="totalNew">0</div>
                <div class="label">신규 입소</div>
            </div>
            <div class="stat-card move" onclick="showStudentsByStatus('이동')">
                <h3>이동</h3>
                <div class="number" id="totalMove">0</div>
                <div class="label">이동 예정/완료</div>
            </div>
            <div class="stat-card absent" onclick="showStudentsByStatus('등미')">
                <h3>등미</h3>
                <div class="number" id="totalAbsent">0</div>
                <div class="label">등록 미입소</div>
            </div>
            <div class="stat-card exit" onclick="showStudentsByStatus('퇴소')">
                <h3>퇴소</h3>
                <div class="number" id="totalExit">0</div>
                <div class="label">퇴소 처리</div>
            </div>
        </div>

        <!-- 성별 통계 -->
        <div class="gender-stats">
            <div class="gender-section male">
                <h3>👨 남학생 현황</h3>
                <div class="gender-cards" id="maleStats">
                    <div class="gender-card" onclick="showStudentsByGender('male', 'total')">
                        <div class="number" id="maleCurrent">0</div>
                        <div class="label">현재원</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '외박')">
                        <div class="number" id="maleOut">0</div>
                        <div class="label">외박</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '신규')">
                        <div class="number" id="maleNew">0</div>
                        <div class="label">신규</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '등미')">
                        <div class="number" id="maleAbsent">0</div>
                        <div class="label">등미</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '이동-')">
                        <div class="number" id="maleMoveOut">0</div>
                        <div class="label">이동-</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '이동+')">
                        <div class="number" id="maleMoveIn">0</div>
                        <div class="label">이동+</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('male', '퇴소')">
                        <div class="number" id="maleExit">0</div>
                        <div class="label">퇴소</div>
                    </div>
                </div>
            </div>
            <div class="gender-section female">
                <h3>👩 여학생 현황</h3>
                <div class="gender-cards" id="femaleStats">
                    <div class="gender-card" onclick="showStudentsByGender('female', 'total')">
                        <div class="number" id="femaleCurrent">0</div>
                        <div class="label">현재원</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '외박')">
                        <div class="number" id="femaleOut">0</div>
                        <div class="label">외박</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '신규')">
                        <div class="number" id="femaleNew">0</div>
                        <div class="label">신규</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '등미')">
                        <div class="number" id="femaleAbsent">0</div>
                        <div class="label">등미</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '이동-')">
                        <div class="number" id="femaleMoveOut">0</div>
                        <div class="label">이동-</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '이동+')">
                        <div class="number" id="femaleMoveIn">0</div>
                        <div class="label">이동+</div>
                    </div>
                    <div class="gender-card" onclick="showStudentsByGender('female', '퇴소')">
                        <div class="number" id="femaleExit">0</div>
                        <div class="label">퇴소</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 구역별 담당자 현황 (24개 구역) -->
        <div class="manager-stats">
            <h3>👥 각 동,층별 인원 현황 </h3>
            <div class="area-info-summary">
                <p>A동~F동까지 각 층별 담당자 및 현황</p>
            </div>
            <div class="area-managers-grid" id="areaManagersGrid">
                <!-- 구역별 담당자 카드들이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>

        <!-- 로딩 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>데이터를 불러오는 중...</p>
        </div>
    </div>

    <!-- 학생 정보 모달 -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">학생 상세 정보</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="students-grid" id="modalStudentsGrid">
                    <!-- 학생 정보 카드들이 여기에 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let sheetsData = [];
        let reportData = {};
        let searchTimeout;

        // 기숙사 정보 정의
        const buildingInfo = {
            'A': { name: 'A동', type: '남학생', gender: 'male' },
            'B': { name: 'B동', type: '남학생', gender: 'male' },
            'C': { name: 'C동', type: '남학생', gender: 'male' },
            'D': { name: 'D동', type: '여학생', gender: 'female' },
            'E': { name: 'E동', type: '여학생', gender: 'female' },
            'F': { name: 'F동', type: '남학생', gender: 'male' }
        };

        // 담당자별 담당 구역 정보 (24개 구역으로 확장)
        const managerInfo = {
            '이상민T': ['A동1층'],
            '김영현T': ['A동2층'],
            '조영권T': ['A동3층'],
            '남인달T(A동총괄)': ['A동4층'],
            '신규T1': ['B동1층'],
            '신규T2': ['B동2층'],
            '송인수T': ['B동3층'],
            '김건희T': ['B동4층'],
            '나정우T': ['C동1층'],
            '강지훈T': ['C동2층'],
            '황민철T': ['C동3층'],
            '고승완T(C동총괄)': ['C동4층'],
            '신규T3': ['D동1층'],
            '김혜정T(D,E총괄)': ['D동2층'],
            '유나경T': ['D동3층'],
            '김미경T': ['D동4층'],
            '김정아T': ['E동1층'],
            '김지현T': ['E동2층'],
            '원현주T': ['E동3층'],
            '진정현T': ['E동4층'],
            '상담층': ['F동1층'],
            '신규T4': ['F동2층'],
            '이시우T(B,F총괄)': ['F동3층'],
            '이영운T': ['F동4층']

        };

        // 3인실 셀 범위
        const tripleRoomRanges = {
            'A': { start: 188, end: 432 },
            'B': { start: 406, end: 468 },
            'C': { start: 654, end: 749 },
            'D': { start: 884, end: 952 },
            'E': { start: 1185, end: 1304 },
            'F': { start: 1403, end: 1453 }
        };

        // 페이지 로드 시 초기화 (완전 수정)
        window.addEventListener('load', async function() {
            console.log('대시보드 초기화 시작...');
            
            // 직접 데이터 로드 함수 호출
            showLoading(true);
            try {
                console.log('데이터 로드 시작...');
                
                // 시트 데이터 로드
                const sheetsLoaded = await loadSheetsData();
                if (!sheetsLoaded) {
                    throw new Error('시트 데이터 로드 실패');
                }
                
                // 보고 데이터 초기화 (localStorage에서 직접 처리)
                try {
                    const savedData = localStorage.getItem('reportData');
                    reportData = savedData ? JSON.parse(savedData) : {};
                    console.log('보고 데이터 초기화 완료');
                } catch (storageError) {
                    console.warn('보고 데이터 초기화 실패, 빈 객체로 설정:', storageError);
                    reportData = {};
                }
                
                // 대시보드 업데이트
                updateDashboard();
                
                showLoading(false);
                console.log('데이터 로드 완료');
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showLoading(false);
                
                // 사용자에게 오류 메시지 표시
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #ef4444; margin-bottom: 20px;">⚠️ 데이터 로드 실패</h3>
                        <p style="color: #6b7280; margin-bottom: 20px;">${error.message}</p>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            🔄 다시 시도
                        </button>
                    </div>
                `;
                loadingEl.style.display = 'block';
            }
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // 주기적 새로고침 설정 (5분마다)
            setInterval(async () => {
                console.log('자동 새로고침 실행...');
                await refreshData();
            }, 5 * 60 * 1000);
        });

        // 데이터 로드 (오류 처리 강화)
        async function loadData() {
            showLoading(true);
            try {
                console.log('데이터 로드 시작...');
                
                // 시트 데이터 로드
                const sheetsLoaded = await loadSheetsData();
                if (!sheetsLoaded) {
                    throw new Error('시트 데이터 로드 실패');
                }
                
                // 보고 데이터 로드
                loadReportData();
                
                // 대시보드 업데이트
                updateDashboard();
                
                showLoading(false);
                console.log('데이터 로드 완료');
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showLoading(false);
                
                // 사용자에게 오류 메시지 표시
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #ef4444; margin-bottom: 20px;">⚠️ 데이터 로드 실패</h3>
                        <p style="color: #6b7280; margin-bottom: 20px;">네트워크 연결이나 API 키를 확인해주세요.</p>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            🔄 다시 시도
                        </button>
                    </div>
                `;
                loadingEl.style.display = 'block';
            }
        }

        // 대시보드 업데이트 (오류 처리 강화)
        function updateDashboard() {
            try {
                console.log('대시보드 업데이트 시작...');
                
                if (!sheetsData || sheetsData.length === 0) {
                    console.error('시트 데이터가 없습니다.');
                    throw new Error('시트 데이터가 없습니다.');
                }

                const stats = calculateStats();
                
                if (!stats) {
                    console.error('통계 계산 실패');
                    throw new Error('통계 계산 실패');
                }

                updateTotalStats(stats);
                updateGenderStats(stats);
                updateAreaManagerStats(stats);  // 구역별 담당자 통계 업데이트
                
                console.log('대시보드 업데이트 완료');
            } catch (error) {
                console.error('대시보드 업데이트 오류:', error);
                throw error; // 상위로 오류 전파
            }
        }

        // 데이터 새로고침
        async function refreshData() {
            try {
                console.log('데이터 새로고침 시작...');
                const sheetsLoaded = await loadSheetsData();
                if (sheetsLoaded) {
                    updateDashboard();
                    console.log('데이터 새로고침 완료');
                    
                    // 성공 메시지 표시 (선택사항)
                    showTemporaryMessage('✅ 데이터가 성공적으로 새로고침되었습니다.', 'success');
                }
            } catch (error) {
                console.error('데이터 새로고침 실패:', error);
                showTemporaryMessage('❌ 데이터 새로고침에 실패했습니다.', 'error');
            }
        }

        // 임시 메시지 표시 함수
        function showTemporaryMessage(message, type) {
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: linear-gradient(135deg, #10b981, #059669);' : 'background: linear-gradient(135deg, #ef4444, #dc2626);'}
            `;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }

        // 수동 새로고침 버튼 추가
        function addRefreshButton() {
            const header = document.querySelector('.header');
            const refreshBtn = document.createElement('button');
            refreshBtn.innerHTML = '🔄 새로고침';
            refreshBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: linear-gradient(135deg, #4f46e5, #7c3aed);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
                transition: all 0.3s ease;
            `;
            
            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '🔄 새로고침 중...';
                await refreshData();
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '🔄 새로고침';
            });
            
            header.style.position = 'relative';
            header.appendChild(refreshBtn);
        }

        // 새로고침 버튼 추가 (페이지 로드 후)
        setTimeout(() => {
            try {
                addRefreshButton();
            } catch (error) {
                console.log('새로고침 버튼 추가 실패:', error);
            }
        }, 2000);

        // 구글 시트 데이터 로드 (올바른 범위로 수정)
        async function loadSheetsData() {
            try {
                console.log('시트 데이터 로드 시도 중...');
                
                // 방법 1: 공개 시트 CSV 방식 (더 안정적)
                const csvUrl = `https://docs.google.com/spreadsheets/d/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/export?format=csv&gid=0`;
                
                try {
                    console.log('CSV 방식으로 시도 중...');
                    const csvResponse = await fetch(csvUrl);
                    
                    if (csvResponse.ok) {
                        const csvText = await csvResponse.text();
                        const allData = parseCSV(csvText);
                        
                        // B3부터 시작하는 데이터만 추출 (B=2번째 열, 3=3번째 행)
                        sheetsData = [];
                        
                        // 헤더 (B3:P3)
                        if (allData.length > 2 && allData[2].length > 1) {
                            const header = allData[2].slice(1, 16); // B3:P3 (B열=1번 인덱스부터 P열=15번 인덱스까지)
                            sheetsData.push(['인덱스'].concat(header)); // 인덱스 열 추가
                        }
                        
                        // 데이터 (B4부터)
                        for (let i = 3; i < allData.length; i++) {
                            if (allData[i].length > 1) {
                                const row = allData[i].slice(1, 16); // B열:P열
                                if (row.some(cell => cell && cell.trim() !== '')) { // 빈 행이 아닌 경우만
                                    sheetsData.push([i].concat(row)); // 행 번호와 함께 추가
                                }
                            }
                        }
                        
                        console.log('CSV 방식 성공:', sheetsData.length, '행 (헤더 포함)');
                        return true;
                    }
                } catch (csvError) {
                    console.log('CSV 방식 실패, API 방식으로 전환:', csvError);
                }
                
                // 방법 2: Google Sheets API 방식 (올바른 범위)
                const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/1RqPfs1VbguAP85a9uswfLeUdYVAGye6GIKr0tvg4oYc/values/yulee!B3:P1000?key=AIzaSyAAaDiNQC3o779j_4pzVC4ouuZr48Y-PbY`;
                
                console.log('API 방식으로 시도 중... (범위: B3:P1000)');
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('API 키가 유효하지 않거나 할당량을 초과했습니다. (403 Forbidden)');
                    } else if (response.status === 404) {
                        throw new Error('스프레드시트를 찾을 수 없습니다. 시트가 공개되어 있는지 확인해주세요. (404 Not Found)');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('B3:P1000 범위에 데이터가 없습니다.');
                }
                
                // API에서 받은 데이터를 올바른 형식으로 변환
                sheetsData = [];
                
                // 헤더 추가 (첫 번째 행)
                sheetsData.push(['인덱스'].concat(data.values[0])); 
                
                // 데이터 추가 (나머지 행들)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row && row.length > 0 && row.some(cell => cell && cell.trim() !== '')) {
                        sheetsData.push([i + 3].concat(row)); // 실제 시트 행 번호 (B4부터 시작하므로 +3)
                    }
                }
                
                console.log('API 방식 성공:', sheetsData.length, '행 (헤더 포함)');
                console.log('첫 5행 데이터:', sheetsData.slice(0, 5));
                return true;
                
            } catch (error) {
                console.error('시트 데이터 로드 실패:', error);
                
                // 사용자에게 구체적인 해결 방법 제시
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; max-width: 600px; margin: 0 auto;">
                        <h3 style="color: #ef4444; margin-bottom: 20px;">⚠️ 데이터 로드 실패</h3>
                        <p style="color: #6b7280; margin-bottom: 15px; line-height: 1.6;">
                            <strong>오류:</strong> ${error.message}
                        </p>
                        <div style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                            <h4 style="color: #374151; margin-bottom: 10px;">확인사항:</h4>
                            <ol style="color: #6b7280; margin-left: 20px; line-height: 1.8;">
                                <li><strong>데이터 위치:</strong> B3부터 헤더가 시작하고 B4부터 데이터가 있는지 확인</li>
                                <li><strong>구글 시트 공개:</strong> 시트 우상단 "공유" → "링크가 있는 모든 사용자"</li>
                                <li><strong>시트 이름:</strong> 하단 탭이 정확히 "yulee"인지 확인</li>
                                <li><strong>네트워크:</strong> 인터넷 연결 상태 확인</li>
                            </ol>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="location.reload()" style="padding: 12px 24px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                🔄 다시 시도
                            </button>
                            <button onclick="tryDemoData()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                📋 데모 데이터로 테스트
                            </button>
                        </div>
                    </div>
                `;
                loadingEl.style.display = 'block';
                return false;
            }
        }

        // CSV 파싱 함수
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            
            lines.forEach(line => {
                if (line.trim()) {
                    // 간단한 CSV 파싱 (따옴표 내 쉼표 고려)
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    row.push(current.trim());
                    result.push(row);
                }
            });
            
            return result;
        }

        // 데모 데이터로 테스트하는 함수
        function tryDemoData() {
            console.log('데모 데이터로 테스트 시작...');
            
            // 간단한 데모 데이터 생성
            sheetsData = [
                ['헤더', '기숙사번호', '이름', '상태', '날짜', '메모', '학부모연락처', '본인연락처', '라이브러리좌석', '생활담임', '', '생년월일', '성별', '입소일', '출신고교', '반'],
                ['1', 'A101', '김철수', '정상', '2025-01-02', '', '010-1234-5678', '010-9876-5432', 'L001', '홍길동', '', '2005-03-15', '남', '2024-03-01', '서울고', '1-1'],
                ['2', 'A102', '이영희', '외박', '2025-01-02', '가족 방문', '010-2345-6789', '010-8765-4321', 'L002', '홍길동', '', '2005-05-20', '여', '2024-03-01', '부산고', '1-1'],
                ['3', 'B201', '박민수', '신규', '2025-01-02', '', '010-3456-7890', '010-7654-3210', 'L003', '김선생', '', '2005-07-10', '남', '2025-01-02', '대구고', '1-2'],
                ['4', 'D301', '최수진', '정상', '2025-01-02', '', '010-4567-8901', '010-6543-2109', 'L004', '이선생', '', '2005-09-25', '여', '2024-03-01', '광주고', '1-3']
            ];
            
            console.log('데모 데이터 로드 완료:', sheetsData.length, '행');
            
            // 로딩 화면 숨기고 대시보드 업데이트
            document.getElementById('loading').style.display = 'none';
            updateDashboard();
            
            // 사용자에게 데모 모드임을 알림
            const header = document.querySelector('.header');
            const demoNotice = document.createElement('div');
            demoNotice.style.cssText = `
                background: linear-gradient(135deg, #f59e0b, #f97316);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                margin-top: 15px;
                text-align: center;
                font-weight: 600;
            `;
            demoNotice.innerHTML = '📋 데모 모드로 실행 중입니다. 실제 데이터 연결을 위해서는 구글 시트 설정을 확인해주세요.';
            header.appendChild(demoNotice);
        }

        // 통계 계산 (D열 상태 기준으로 수정)
        function calculateStats() {
            console.log('통계 계산 시작, 데이터 행 수:', sheetsData.length);
            
            if (!sheetsData || sheetsData.length <= 1) {
                console.warn('데이터가 없거나 헤더만 있습니다.');
                return {
                    total: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                    male: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                    female: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                    buildings: {},
                    managers: {},
                    areas: {}
                };
            }
            
            const stats = {
                total: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                male: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                female: { current: 0, out: 0, new: 0, moveOut: 0, moveIn: 0, absent: 0, exit: 0 },
                buildings: {},
                managers: {},
                areas: {}
            };

            // 각 동별로 초기화
            Object.keys(buildingInfo).forEach(building => {
                stats.buildings[building] = {
                    floors: { '1': 0, '2': 0, '3': 0, '4': 0 },
                    total: 0,
                    gender: buildingInfo[building].gender
                };
            });

            // 담당자별 통계 초기화
            Object.keys(managerInfo).forEach(manager => {
                stats.managers[manager] = {
                    areas: managerInfo[manager],
                    current: 0,
                    out: 0,
                    new: 0,
                    moveOut: 0,
                    moveIn: 0,
                    absent: 0,
                    exit: 0,
                    total: 0
                };
            });

            // 구역별(층별) 통계 초기화
            stats.areas = {};
            Object.keys(managerInfo).forEach(manager => {
                const area = managerInfo[manager][0]; // 각 담당자는 하나의 구역만 담당
                stats.areas[area] = {
                    manager: manager,
                    current: 0,
                    out: 0,
                    new: 0,
                    moveOut: 0,
                    moveIn: 0,
                    absent: 0,
                    exit: 0,
                    total: 0
                };
            });

            let processedCount = 0;

            // 시트 데이터 분석 (헤더 제외하고 1번 인덱스부터)
            for (let index = 1; index < sheetsData.length; index++) {
                const row = sheetsData[index];
                
                // CSV에서 변환된 데이터 구조: [인덱스, B열, C열, D열, E열, ...]
                // 원래 시트: B열=기숙사번호, C열=이름, D열=상태
                const room = row[1]; // B열 (기숙사 번호)
                const name = row[2]; // C열 (학생 이름)  
                const status = row[3] || '정상'; // D열 (상태)

                // 데이터 유효성 검사
                if (!room || !name || name === '미배정' || name.trim() === '') {
                    continue;
                }

                processedCount++;

                // 건물과 층 추출
                const building = room.toString().charAt(0).toUpperCase();
                const floor = room.toString().charAt(1);

                // 건물 정보 확인
                if (!buildingInfo[building]) {
                    console.warn('알 수 없는 건물:', building, 'in room:', room);
                    continue;
                }

                const buildingGender = buildingInfo[building].gender;

                // 전체 통계 업데이트
                updateStatsByStatus(stats.total, status);
                
                // 성별 통계 업데이트
                if (buildingGender === 'male') {
                    updateStatsByStatus(stats.male, status);
                } else if (buildingGender === 'female') {
                    updateStatsByStatus(stats.female, status);
                }

                // 동별 통계 업데이트 (현재원만)
                if (stats.buildings[building] && ['정상', '신규', '이동+'].includes(status)) {
                    if (floor >= '1' && floor <= '4') {
                        stats.buildings[building].floors[floor]++;
                        stats.buildings[building].total++;
                    }
                }

                // 담당자별 통계 업데이트
                const areaKey = `${building}동${floor}층`;
                Object.keys(managerInfo).forEach(manager => {
                    if (managerInfo[manager].includes(areaKey)) {
                        updateStatsByStatus(stats.managers[manager], status);
                        stats.managers[manager].total++;
                    }
                });

                // 구역별 통계 업데이트
                if (stats.areas[areaKey]) {
                    updateStatsByStatus(stats.areas[areaKey], status);
                    stats.areas[areaKey].total++;
                }
            }

            console.log('처리된 학생 수:', processedCount);
            console.log('계산된 통계:', stats);
            
            return stats;
        }

        // 상태별 통계 업데이트 (수정된 로직)
        function updateStatsByStatus(statObj, status) {
            switch (status) {
                case '정상':
                    statObj.current++;
                    break;
                case '신규':
                    statObj.current++;
                    statObj.new++;
                    break;
                case '이동+':
                    statObj.current++;
                    statObj.moveIn++;
                    break;
                case '외박':
                    statObj.out++;
                    break;
                case '이동-':
                    statObj.moveOut++;
                    break;
                case '등미':
                    statObj.absent++;
                    break;
                case '퇴소':
                    statObj.exit++;
                    break;
                default:
                    // 기본값 처리 (정상으로 간주)
                    statObj.current++;
                    break;
            }
        }

        // 전체 통계 업데이트
        function updateTotalStats(stats) {
            document.getElementById('totalCurrent').textContent = stats.total.current;
            document.getElementById('totalOut').textContent = stats.total.out;
            document.getElementById('totalNew').textContent = stats.total.new;
            document.getElementById('totalMove').textContent = stats.total.moveOut + stats.total.moveIn;
            document.getElementById('totalAbsent').textContent = stats.total.absent;
            document.getElementById('totalExit').textContent = stats.total.exit;
        }

        // 성별 통계 업데이트
        function updateGenderStats(stats) {
            // 남학생
            document.getElementById('maleCurrent').textContent = stats.male.current;
            document.getElementById('maleOut').textContent = stats.male.out;
            document.getElementById('maleNew').textContent = stats.male.new;
            document.getElementById('maleAbsent').textContent = stats.male.absent;
            document.getElementById('maleMoveOut').textContent = stats.male.moveOut;
            document.getElementById('maleMoveIn').textContent = stats.male.moveIn;
            document.getElementById('maleExit').textContent = stats.male.exit;

            // 여학생
            document.getElementById('femaleCurrent').textContent = stats.female.current;
            document.getElementById('femaleOut').textContent = stats.female.out;
            document.getElementById('femaleNew').textContent = stats.female.new;
            document.getElementById('femaleAbsent').textContent = stats.female.absent;
            document.getElementById('femaleMoveOut').textContent = stats.female.moveOut;
            document.getElementById('femaleMoveIn').textContent = stats.female.moveIn;
            document.getElementById('femaleExit').textContent = stats.female.exit;
        }

        // 동별 통계 업데이트 함수 제거됨

        // 구역별 담당자 통계 업데이트 (24개 구역)
        function updateAreaManagerStats(stats) {
            const areaManagersGrid = document.getElementById('areaManagersGrid');
            areaManagersGrid.innerHTML = '';

            // 동별로 그룹화하여 표시
            const buildings = ['A', 'B', 'C', 'D', 'E', 'F'];
            
            buildings.forEach(building => {
                const buildingInfo_detail = buildingInfo[building];
                
                // 동별 그룹 컨테이너 생성
                const buildingGroup = document.createElement('div');
                buildingGroup.className = 'building-group';
                
                // 동별 헤더
                const groupHeader = document.createElement('div');
                groupHeader.className = 'building-group-header';
                groupHeader.innerHTML = `
                    <div class="building-group-title">${building}동 (${buildingInfo_detail.type})</div>
                    <div class="building-group-subtitle">1층~4층 인원 현황</div>
                `;
                buildingGroup.appendChild(groupHeader);
                
                // 층별 그리드 컨테이너
                const floorsGrid = document.createElement('div');
                floorsGrid.className = 'floors-grid';
                
                // 각 층별 카드 생성
                for (let floor = 1; floor <= 4; floor++) {
                    const areaKey = `${building}동${floor}층`;
                    const manager = Object.keys(managerInfo).find(mgr => 
                        managerInfo[mgr].includes(areaKey)
                    );
                    
                    // 각 구역별 독립적인 통계 사용
                    const areaData = stats.areas[areaKey];
                    
                    if (manager && areaData) {
                        const areaCard = document.createElement('div');
                        areaCard.className = 'area-manager-card';
                        areaCard.innerHTML = `
                            <div class="area-building-indicator">${floor}층</div>
                            <div class="area-manager-header">
                                <div class="area-manager-name">${manager}</div>
                                <div class="area-manager-zone">${building}동${floor}층</div>
                            </div>
                            <div class="area-stats-compact">
                                <div class="area-stat-item current" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'current')">
                                    <div class="area-stat-number">${areaData.current}</div>
                                    <div class="area-stat-label">현재원</div>
                                </div>
                                <div class="area-stat-item out" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'out')">
                                    <div class="area-stat-number">${areaData.out}</div>
                                    <div class="area-stat-label">외박</div>
                                </div>
                                <div class="area-stat-item new" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'new')">
                                    <div class="area-stat-number">${areaData.new}</div>
                                    <div class="area-stat-label">신규</div>
                                </div>
                                <div class="area-stat-item absent" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'absent')">
                                    <div class="area-stat-number">${areaData.absent}</div>
                                    <div class="area-stat-label">등미</div>
                                </div>
                            </div>
                            <div class="area-stats-compact">
                                <div class="area-stat-item move-out" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'moveOut')">
                                    <div class="area-stat-number">${areaData.moveOut}</div>
                                    <div class="area-stat-label">이동-</div>
                                </div>
                                <div class="area-stat-item move-in" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'moveIn')">
                                    <div class="area-stat-number">${areaData.moveIn}</div>
                                    <div class="area-stat-label">이동+</div>
                                </div>
                                <div class="area-stat-item exit" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'exit')">
                                    <div class="area-stat-number">${areaData.exit}</div>
                                    <div class="area-stat-label">퇴소</div>
                                </div>
                                <div class="area-stat-item" onclick="showAreaManagerStudents('${manager}', '${areaKey}', 'total')">
                                    <div class="area-stat-number">${areaData.total}</div>
                                    <div class="area-stat-label">전체</div>
                                </div>
                            </div>
                            <div class="area-total-summary">
                                총 ${areaData.total}명 담당
                            </div>
                        `;
                        floorsGrid.appendChild(areaCard);
                    }
                }
                
                buildingGroup.appendChild(floorsGrid);
                areaManagersGrid.appendChild(buildingGroup);
            });
        }

        // 구역별 담당자 학생 보기
        function showAreaManagerStudents(manager, areaKey, statusType) {
            const students = getStudentsByAreaManager(manager, areaKey, statusType);
            const statusText = getStatusText(statusType);
            showStudentsModal(`${manager} - ${areaKey} ${statusText} 학생 목록`, students);
        }

        // 구역별 담당자 학생 데이터 가져오기
        function getStudentsByAreaManager(manager, areaKey, statusType) {
            const students = [];
            
            // areaKey에서 동과 층 추출 (예: "A동1층" -> A, 1)
            const building = areaKey.charAt(0);
            const floor = areaKey.charAt(2);
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const room = row[1];
                const name = row[2];
                const status = row[3] || '정상';
                
                if (!room || !name || name === '미배정') return;
                
                // 해당 구역의 방인지 확인
                const roomBuilding = room.toString().charAt(0).toUpperCase();
                const roomFloor = room.toString().charAt(1);
                
                if (roomBuilding !== building || roomFloor !== floor) return;
                
                // 상태별 필터링
                let shouldInclude = false;
                switch (statusType) {
                    case 'current':
                        shouldInclude = (status === '정상' || status === '신규' || status === '이동+');
                        break;
                    case 'out':
                        shouldInclude = (status === '외박');
                        break;
                    case 'new':
                        shouldInclude = (status === '신규');
                        break;
                    case 'moveOut':
                        shouldInclude = (status === '이동-');
                        break;
                    case 'moveIn':
                        shouldInclude = (status === '이동+');
                        break;
                    case 'absent':
                        shouldInclude = (status === '등미');
                        break;
                    case 'exit':
                        shouldInclude = (status === '퇴소');
                        break;
                    case 'total':
                        shouldInclude = true;
                        break;
                }
                
                if (shouldInclude) {
                    students.push(row);
                }
            });
            
            return students;
        }

        // 검색 기능
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (query.length < 1) {
                    searchResults.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            // 검색 결과 외부 클릭 시 숨김
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        // 실시간 검색 수행 (수정: 행 인덱스 추가)
        function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            const results = [];

            const lowerQuery = query.toLowerCase();

            sheetsData.forEach((row, index) => {
                if (index === 0) return; // 헤더 제외

                const room = row[1] || '';
                const name = row[2] || '';
                const status = row[3] || '정상';
                const librarySeats = row[8] || '';
                const phone = row[7] || '';
                const parentPhone = row[6] || '';

                // 검색 조건들
                const searchFields = [
                    room.toLowerCase(),
                    name.toLowerCase(),
                    librarySeats.toLowerCase(),
                    phone,
                    parentPhone
                ].join(' ');

                if (searchFields.includes(lowerQuery) && name && name !== '미배정') {
                    results.push({
                        room: room,
                        name: name,
                        status: status,
                        rowData: row,
                        rowIndex: index  // 행 인덱스 추가
                    });
                }
            });

            displaySearchResults(results);
        }

        // 검색 결과 표시 (수정: 행 인덱스 기반 클릭)
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">검색 결과가 없습니다.</div>';
            } else {
                searchResults.innerHTML = results.map((result, index) => `
                    <div class="search-result-item" onclick="showStudentDetailByIndex(${result.rowIndex})">
                        <div class="result-room">${result.room}</div>
                        <div class="result-name">${result.name}</div>
                        <div class="result-status">상태: ${result.status}</div>
                    </div>
                `).join('');
            }
            
            searchResults.style.display = 'block';
        }

        // 상태별 학생 보기
        function showStudentsByStatus(status) {
            const students = getStudentsByStatus(status);
            showStudentsModal(`${status} 학생 목록`, students);
        }

        // 성별 + 상태별 학생 보기
        function showStudentsByGender(gender, status) {
            const students = getStudentsByGenderAndStatus(gender, status);
            const genderText = gender === 'male' ? '남학생' : '여학생';
            showStudentsModal(`${genderText} ${status} 목록`, students);
        }

        // 층별 학생 보기
        function showFloorStudents(building, floor) {
            const students = getStudentsByFloor(building, floor);
            showStudentsModal(`${building}동 ${floor}층 학생 목록`, students);
        }

        // 담당자별 학생 보기
        function showManagerStudents(manager, statusType) {
            const students = getStudentsByManager(manager, statusType);
            const statusText = getStatusText(statusType);
            showStudentsModal(`${manager} - ${statusText} 학생 목록`, students);
        }

        // 특정 학생 상세 정보 보기 (기존 방식 - 호실 기준)
        function showStudentDetail(room) {
            const student = sheetsData.find(row => row[1] === room);
            if (student) {
                showStudentsModal(`${room} 학생 정보`, [student]);
            }
            document.getElementById('searchResults').style.display = 'none';
        }

        // 인덱스로 특정 학생 상세 정보 보기 (새로운 방식 - 정확한 학생 선택)
        function showStudentDetailByIndex(rowIndex) {
            const student = sheetsData[rowIndex];
            if (student) {
                const room = student[1] || '';
                const name = student[2] || '';
                showStudentsModal(`${room} ${name} 학생 정보`, [student]);
            }
            document.getElementById('searchResults').style.display = 'none';
        }

        // 상태별 학생 데이터 가져오기
        function getStudentsByStatus(status) {
            const students = [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const name = row[2];
                const studentStatus = row[3] || '정상';
                
                if (!name || name === '미배정') return;
                
                if (status === 'total') {
                    if (studentStatus === '정상' || studentStatus === '신규' || studentStatus === '이동+') {
                        students.push(row);
                    }
                } else if (status === '이동') {
                    if (studentStatus === '이동-' || studentStatus === '이동+') {
                        students.push(row);
                    }
                } else if (studentStatus === status) {
                    students.push(row);
                }
            });
            
            return students;
        }

        // 담당자별 학생 데이터 가져오기
        function getStudentsByManager(manager, statusType) {
            const students = [];
            const managerAreas = managerInfo[manager] || [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const room = row[1];
                const name = row[2];
                const status = row[3] || '정상';
                
                if (!room || !name || name === '미배정') return;
                
                // 담당 구역 확인
                const building = room.toString().charAt(0).toUpperCase();
                const floor = room.toString().charAt(1);
                const areaKey = `${building}동${floor}층`;
                
                if (!managerAreas.includes(areaKey)) return;
                
                // 상태별 필터링
                let shouldInclude = false;
                switch (statusType) {
                    case 'current':
                        shouldInclude = (status === '정상' || status === '신규' || status === '이동+');
                        break;
                    case 'out':
                        shouldInclude = (status === '외박');
                        break;
                    case 'new':
                        shouldInclude = (status === '신규');
                        break;
                    case 'moveOut':
                        shouldInclude = (status === '이동-');
                        break;
                    case 'moveIn':
                        shouldInclude = (status === '이동+');
                        break;
                    case 'absent':
                        shouldInclude = (status === '등미');
                        break;
                    case 'exit':
                        shouldInclude = (status === '퇴소');
                        break;
                    case 'total':
                        shouldInclude = true;
                        break;
                }
                
                if (shouldInclude) {
                    students.push(row);
                }
            });
            
            return students;
        }

        // 상태 텍스트 반환
        function getStatusText(statusType) {
            const statusTexts = {
                'current': '현재원',
                'out': '외박',
                'new': '신규',
                'moveOut': '이동-',
                'moveIn': '이동+',
                'absent': '등미',
                'exit': '퇴소',
                'total': '전체'
            };
            return statusTexts[statusType] || statusType;
        }

        // 성별 + 상태별 학생 데이터 가져오기
        function getStudentsByGenderAndStatus(gender, status) {
            const students = [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const room = row[1];
                const name = row[2];
                const studentStatus = row[3] || '정상';
                
                if (!room || !name || name === '미배정') return;
                
                // 성별 확인
                const building = room.charAt(0);
                if (!buildingInfo[building] || buildingInfo[building].gender !== gender) return;
                
                // 상태별 필터링
                if (status === 'total') {
                    if (studentStatus === '정상' || studentStatus === '신규' || studentStatus === '이동+') {
                        students.push(row);
                    }
                } else if (studentStatus === status) {
                    students.push(row);
                }
            });
            
            return students;
        }

        // 층별 학생 데이터 가져오기
        function getStudentsByFloor(building, floor) {
            const students = [];
            
            sheetsData.forEach((row, index) => {
                if (index === 0) return;
                
                const room = row[1];
                const name = row[2];
                const status = row[3] || '정상';
                
                if (!room || !name || name === '미배정') return;
                
                if (room.startsWith(building + floor)) {
                    if (status === '정상' || status === '신규' || status === '이동+') {
                        students.push(row);
                    }
                }
            });
            
            return students;
        }

        // 학생 모달 표시
        function showStudentsModal(title, students) {
            document.getElementById('modalTitle').textContent = title;
            const modalStudentsGrid = document.getElementById('modalStudentsGrid');
            
            modalStudentsGrid.innerHTML = students.map(row => createStudentCard(row)).join('');
            document.getElementById('studentModal').style.display = 'block';
        }

        // 학생 정보 카드 생성
        function createStudentCard(row) {
            const room = row[1] || '';
            const name = row[2] || '';
            const status = row[3] || '정상';
            const memo = row[5] || '';
            const parentPhone = row[6] || '';
            const phone = row[7] || '';
            const librarySeats = row[8] || '';
            const group = row[9] || '';  // 그룹 정보 추가 (J열)
            const lifeTeacher = row[10] || '';  // 생활담임은 K열로 이동
            const birthDate = row[11] || '';
            const gender = row[12] || '';
            const enrollDate = row[13] || '';
            const school = row[14] || '';
            const classroom = row[15] || '';

            const statusClass = getStatusClass(status);

            return `
                <div class="student-info-card">
                    <div class="student-info-header">
                        <div class="student-room">${room}</div>
                        <div class="student-status ${statusClass}">${status}</div>
                    </div>
                    <div class="student-details">
                        <div class="detail-item">
                            <div class="detail-label">이름</div>
                            <div class="detail-value">${name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">성별</div>
                            <div class="detail-value">${gender}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">그룹</div>
                            <div class="detail-value">${group}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">생년월일</div>
                            <div class="detail-value">${birthDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">본인연락처</div>
                            <div class="detail-value">${phone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">학부모연락처</div>
                            <div class="detail-value">${parentPhone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">라이브러리 좌석</div>
                            <div class="detail-value">${librarySeats}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">생활담임</div>
                            <div class="detail-value">${lifeTeacher}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">입소일</div>
                            <div class="detail-value">${enrollDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">출신고교</div>
                            <div class="detail-value">${school}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">반</div>
                            <div class="detail-value">${classroom}</div>
                        </div>
                        ${memo ? `
                        <div class="detail-item">
                            <div class="detail-label">비고</div>
                            <div class="detail-value">${memo}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 상태 CSS 클래스 반환
        function getStatusClass(status) {
            switch (status) {
                case '정상': return 'status-normal';
                case '외박': return 'status-out';
                case '신규': return 'status-new';
                case '이동-':
                case '이동+': return 'status-move';
                case '등미': return 'status-absent';
                case '퇴소': return 'status-exit';
                default: return 'status-normal';
            }
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('studentModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // 로딩 표시/숨김
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 데이터 새로고침
        function refreshData() {
            loadData();
        }

        // 5분마다 자동 새로고침
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>
